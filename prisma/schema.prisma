generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  name          String?
  image         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")
  lastSeenAt    DateTime? @map("last_seen_at")

  // Subscription fields
  subscriptionTier   SubscriptionTier @default(FREE) @map("subscription_tier")
  subscriptionStatus SubscriptionStatus @default(ACTIVE) @map("subscription_status")
  subscriptionId     String? @unique @map("subscription_id") // Stripe subscription ID
  customerId         String? @unique @map("customer_id") // Stripe customer ID

  // Usage tracking
  explorationsUsed   Int      @default(0) @map("explorations_used")
  explorationsReset  DateTime @default(now()) @map("explorations_reset")
  explorationsTotal  Int      @default(0) @map("explorations_total")
  totalInputTokens   Int      @default(0) @map("total_input_tokens")
  totalOutputTokens  Int      @default(0) @map("total_output_tokens")
  totalTokensUsed    Int      @default(0) @map("total_tokens_used")
  totalEstimatedCostUsd Decimal @default(0) @db.Decimal(12, 6) @map("total_estimated_cost_usd")

  accounts      Account[]       @relation()
  authSessions  Session[]       @relation("AuthSessions")
  graphSessions GraphSession[]  @relation("GraphSessions")
  usageEvents   UsageEvent[]
  questionEvents QuestionEvent[]
  suggestionCaches SuggestionCache[]

  @@map("users")
}

enum SubscriptionTier {
  FREE
  STARTER
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  INCOMPLETE
}

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Auth.js Session model for authentication
model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation("AuthSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@map("auth_sessions")
}

// Graph Session model for your application
model GraphSession {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  rootQuery String   @map("root_query")
  title     String?
  isPublic  Boolean  @default(false) @map("is_public")
  nodeCount Int      @default(0) @map("node_count")
  maxDepth  Int      @default(0) @map("max_depth")
  clientId  String?  @map("client_id")
  ipAddress String?  @map("ip_address")
  ipHash    String?  @map("ip_hash")
  country   String?
  region    String?
  city      String?
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User?   @relation("GraphSessions", fields: [userId], references: [id], onDelete: Cascade)
  nodes   Node[]
  edges   Edge[]
  history ConversationHistory[]
  usageEvents UsageEvent[]
  questionEvents QuestionEvent[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([isPublic, createdAt(sort: Desc)])
  @@index([clientId])
  @@map("sessions")
}

model Node {
  id         String   @id @default(uuid())
  sessionId  String   @map("session_id")
  parentId   String?  @map("parent_id")

  title      String
  content    String?
  summary    String?

  depth      Int
  positionX  Float    @map("position_x")
  positionY  Float    @map("position_y")

  explored   Boolean  @default(false)
  followUpType String? @map("follow_up_type") // why, how, what, example, compare

  createdAt  DateTime @default(now()) @map("created_at")

  session    GraphSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  parent     Node?         @relation("NodeChildren", fields: [parentId], references: [id], onDelete: Cascade)
  children   Node[]        @relation("NodeChildren")

  edgesAsSource Edge[] @relation("SourceEdges")
  edgesAsTarget Edge[] @relation("TargetEdges")

  @@index([sessionId])
  @@index([parentId])
  @@index([sessionId, depth])
  @@map("nodes")
}

model Edge {
  id        String  @id @default(uuid())
  sessionId String  @map("session_id")
  sourceId  String  @map("source_id")
  targetId  String  @map("target_id")

  animated  Boolean @default(true)

  session   GraphSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  source    Node         @relation("SourceEdges", fields: [sourceId], references: [id], onDelete: Cascade)
  target    Node         @relation("TargetEdges", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([sourceId, targetId])
  @@index([sessionId])
  @@map("edges")
}

model ConversationHistory {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  nodeId    String?  @map("node_id")

  role      String
  content   String

  createdAt DateTime @default(now()) @map("created_at")

  session   GraphSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("conversation_history")
}

// Anonymous Session models - for users exploring without signing in
model AnonymousSession {
  id        String   @id @default(uuid())
  rootQuery String   @map("root_query")
  title     String?
  nodeCount Int      @default(0) @map("node_count")
  maxDepth  Int      @default(0) @map("max_depth")
  clientId  String?  @map("client_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  lastActivityAt DateTime @default(now()) @map("last_activity_at")

  // Optional: Track IP or browser fingerprint for analytics
  ipAddress String?  @map("ip_address")
  ipHash    String?  @map("ip_hash")
  country   String?
  region    String?
  city      String?
  userAgent String?  @map("user_agent")

  nodes   AnonymousNode[]
  edges   AnonymousEdge[]
  history AnonymousConversationHistory[]
  usageEvents UsageEvent[]
  questionEvents QuestionEvent[]

  @@index([createdAt(sort: Desc)])
  @@index([clientId])
  @@map("anonymous_sessions")
}

model AnonymousNode {
  id         String   @id @default(uuid())
  sessionId  String   @map("session_id")
  parentId   String?  @map("parent_id")

  title      String
  content    String?
  summary    String?

  depth      Int
  positionX  Float    @map("position_x")
  positionY  Float    @map("position_y")

  explored   Boolean  @default(false)
  followUpType String? @map("follow_up_type") // why, how, what, example, compare

  createdAt  DateTime @default(now()) @map("created_at")

  session    AnonymousSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  parent     AnonymousNode?    @relation("AnonymousNodeChildren", fields: [parentId], references: [id], onDelete: Cascade)
  children   AnonymousNode[]   @relation("AnonymousNodeChildren")

  edgesAsSource AnonymousEdge[] @relation("AnonymousSourceEdges")
  edgesAsTarget AnonymousEdge[] @relation("AnonymousTargetEdges")

  @@index([sessionId])
  @@index([parentId])
  @@index([sessionId, depth])
  @@map("anonymous_nodes")
}

model AnonymousEdge {
  id        String  @id @default(uuid())
  sessionId String  @map("session_id")
  sourceId  String  @map("source_id")
  targetId  String  @map("target_id")

  animated  Boolean @default(true)

  session   AnonymousSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  source    AnonymousNode    @relation("AnonymousSourceEdges", fields: [sourceId], references: [id], onDelete: Cascade)
  target    AnonymousNode    @relation("AnonymousTargetEdges", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([sourceId, targetId])
  @@index([sessionId])
  @@map("anonymous_edges")
}

model AnonymousConversationHistory {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  nodeId    String?  @map("node_id")

  role      String
  content   String

  createdAt DateTime @default(now()) @map("created_at")

  session   AnonymousSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("anonymous_conversation_history")
}

model UsageEvent {
  id                 String   @id @default(uuid())
  eventName          String   @map("event_name")
  userId             String?  @map("user_id")
  graphSessionId     String?  @map("graph_session_id")
  anonymousSessionId String?  @map("anonymous_session_id")
  requestId          String?  @map("request_id")
  clientId           String?  @map("client_id")
  route              String?
  success            Boolean?
  statusCode         Int?     @map("status_code")
  latencyMs          Float?   @map("latency_ms")
  model              String?
  inputTokens        Int      @default(0) @map("input_tokens")
  outputTokens       Int      @default(0) @map("output_tokens")
  totalTokens        Int      @default(0) @map("total_tokens")
  estimatedCostUsd   Decimal  @default(0) @db.Decimal(12, 6) @map("estimated_cost_usd")
  ipAddress          String?  @map("ip_address")
  ipHash             String?  @map("ip_hash")
  country            String?
  region             String?
  city               String?
  userAgent          String?  @map("user_agent")
  metadata           Json?
  createdAt          DateTime @default(now()) @map("created_at")

  user             User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  graphSession     GraphSession?     @relation(fields: [graphSessionId], references: [id], onDelete: SetNull)
  anonymousSession AnonymousSession? @relation(fields: [anonymousSessionId], references: [id], onDelete: SetNull)

  @@index([createdAt(sort: Desc)])
  @@index([eventName, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([graphSessionId, createdAt(sort: Desc)])
  @@index([anonymousSessionId, createdAt(sort: Desc)])
  @@map("usage_events")
}

enum QuestionSource {
  TYPED
  SUGGESTION
}

enum SuggestionAudienceType {
  USER
  CLIENT
}

model QuestionEvent {
  id                 String   @id @default(uuid())
  questionText       String   @map("question_text")
  normalizedText     String   @map("normalized_text")
  source             QuestionSource @default(TYPED)
  userId             String?  @map("user_id")
  graphSessionId     String?  @map("graph_session_id")
  anonymousSessionId String?  @map("anonymous_session_id")
  clientId           String?  @map("client_id")
  country            String?
  region             String?
  userAgent          String?  @map("user_agent")
  metadata           Json?
  createdAt          DateTime @default(now()) @map("created_at")

  user             User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  graphSession     GraphSession?     @relation(fields: [graphSessionId], references: [id], onDelete: SetNull)
  anonymousSession AnonymousSession? @relation(fields: [anonymousSessionId], references: [id], onDelete: SetNull)

  @@index([createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([clientId, createdAt(sort: Desc)])
  @@index([graphSessionId, createdAt(sort: Desc)])
  @@index([anonymousSessionId, createdAt(sort: Desc)])
  @@index([normalizedText])
  @@map("question_events")
}

model SuggestionCache {
  id           String               @id @default(uuid())
  audienceType SuggestionAudienceType @map("audience_type")
  audienceKey  String               @map("audience_key")
  userId       String?              @map("user_id")
  suggestions  Json
  source       String?
  model        String?
  generatedAt  DateTime             @default(now()) @map("generated_at")
  nextRefreshAt DateTime            @map("next_refresh_at")
  lastStatus   String?              @map("last_status")
  createdAt    DateTime             @default(now()) @map("created_at")
  updatedAt    DateTime             @updatedAt @map("updated_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([audienceType, audienceKey])
  @@index([nextRefreshAt])
  @@index([userId, updatedAt(sort: Desc)])
  @@map("suggestion_caches")
}
